(defn init-player-inventory
  "Initialize inventory for a new player"
  [player-name]
  (swap! player-inventories assoc player-name (ref #{}))
  (get @player-inventories player-name))

(defn get-player-inventory
  "Get player's inventory ref"
  [player-name]
  (get @player-inventories player-name))

(defn player-has-item?
  "Check if player has specific item"
  [player-name item]
  (let [inv (get-player-inventory player-name)]
    (when inv
      (@inv (keyword item)))))


(defn give
  "Give an item to another player in the same room."
  [item recipient]
  (dosync
   (let [item-key (keyword item)
         current-room @player/*current-room*
         inhabitants @(:inhabitants current-room)
         recipient-inv (rooms/get-player-inventory recipient)]
     (cond
       (not (player/carrying? item))
         (str "You're not carrying a " item ".")
       
       (not (contains? inhabitants recipient))
         (str recipient " is not in this room.")
       
       (nil? recipient-inv))
         (str "Cannot give item to " recipient ".")
       
       :else
         (do
           ;; Перемещаем предмет между инвентарями
           (alter player/*inventory* disj item-key)
           (alter recipient-inv conj item-key)
           
           ;; Уведомляем игроков
           (doseq [inhabitant (disj inhabitants player/*name*)]
             (when-let [out (player/streams inhabitant)]
               (binding [*out* out]
                 (println (str player/*name* " gave " item " to " recipient "."))
                 (println player/prompt))))
           
           (str "You gave " item " to " recipient "."))))))




(rooms/init-player-inventory player-name
